{% extends 'base.html' %}
{% load static %}
{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ | AniParser{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<div class="settings-container">

    <aside class="settings-sidebar">
        <div class="sidebar-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <nav class="settings-nav">
            <button type="button" class="st-nav-item active" onclick="switchTab('profile')">
                <span class="icon">üë§</span> –ü—Ä–æ—Ñ–∏–ª—å
            </button>
            <button type="button" class="st-nav-item" onclick="switchTab('player')">
                <span class="icon">‚ñ∂</span> –ü–ª–µ–µ—Ä
            </button>
            <button type="button" class="st-nav-item" onclick="switchTab('interface')">
                <span class="icon">üé®</span> –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            </button>
            <button type="button" class="st-nav-item danger" onclick="switchTab('security')">
                <span class="icon">üõ°</span> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            </button>
        </nav>
    </aside>

    <form method="post" enctype="multipart/form-data" class="settings-content" data-no-swup>
        {% csrf_token %}
        <input type="hidden" name="accent_color" id="accentInput" value="{{ user.profile.accent_color|default:'purple' }}">

        <div id="profile" class="tab-pane active">
            <h2 class="pane-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>

            <div class="avatar-upload-section">
                <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(this)">

                <div class="current-avatar" onclick="document.getElementById('avatarInput').click()">
                    {% if user.profile.avatar %}
                        <img id="avatarPreview" src="{{ user.profile.avatar.url }}" alt="Avatar">
                    {% else %}
                        <div id="avatarPlaceholder" class="avatar-placeholder">{{ user.username|first|upper }}</div>
                        <img id="avatarPreview" src="" alt="Avatar" style="display: none;">
                    {% endif %}
                    <div class="edit-overlay">üì∑</div>
                </div>

                <div class="avatar-info">
                    <h3>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å.</p>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('avatarInput').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ</button>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" name="username" value="{{ user.username }}" class="st-input">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" value="{{ user.email }}" class="st-input">
                </div>
                <div class="form-group full">
                    <label>–û —Å–µ–±–µ</label>
                    <textarea name="bio" class="st-input" rows="3" placeholder="–ü–∞—Ä—É —Å–ª–æ–≤ –æ –≤–∞—à–∏—Ö –≤–∫—É—Å–∞—Ö...">{{ user.profile.bio }}</textarea>
                </div>
            </div>
        </div>

        <div id="player" class="tab-pane">
            <h2 class="pane-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞</h2>
            <div class="settings-list">

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Ä–∏–∏</h3>
                        <p>–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —ç–ø–∏–∑–æ–¥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="auto_next" {% if user.profile.auto_next %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ–ø–µ–Ω–∏–Ω–≥–∏</h3>
                        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∂–∏–º–∞—Ç—å "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–ø–µ–Ω–∏–Ω–≥".</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="auto_skip_intro" {% if user.profile.auto_skip_intro %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h3>
                        <p>–í—ã–±–∏—Ä–∞—Ç—å —ç—Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.</p>
                    </div>
                    <select name="default_quality" class="st-select">
                        <option value="1080" {% if user.profile.default_quality == '1080' %}selected{% endif %}>1080p (Full HD)</option>
                        <option value="720" {% if user.profile.default_quality == '720' %}selected{% endif %}>720p (HD)</option>
                        <option value="480" {% if user.profile.default_quality == '480' %}selected{% endif %}>480p (SD)</option>
                    </select>
                </div>

            </div>
        </div>

        <div id="interface" class="tab-pane">
            <h2 class="pane-title">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h2>
            <div class="settings-list">

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
                    </div>
                    <div class="color-picker">
                        <button type="button"
                                class="color-swatch purple"
                                onclick="changeAccent('purple')"
                                title="Cyber Purple">
                        </button>

                        <button type="button"
                                class="color-swatch orange"
                                onclick="changeAccent('orange')"
                                title="Neon Lava">
                        </button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ (Backdrop)</h3>
                        <p>–û—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="backdrop_blur" {% if user.profile.backdrop_blur %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</h3>
                        <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–º–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="dark_theme" {% if user.profile.dark_theme %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div id="security" class="tab-pane">
            <h2 class="pane-title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
            {% if user.profile.telegram_id %}
                <div class="tg-connected">
                    <span class="status-badge">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                    <span class="tg-id">ID: {{ user.profile.telegram_id }}</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">
                    –ë–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å—é–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
                </p>
            {% else %}
                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.</p>
                <a href="{% url 'connect_telegram' %}" class="auth-btn tg-btn" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2z"/></svg>
                    –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
                </a>
            {% endif %}

            <div class="security-card" style="margin-top: 30px;">
                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ü–∞—Ä–æ–ª—å</h3>
                        <p>–°–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞ –Ω–æ–≤—ã–π.</p>
                    </div>
                    <a href="{% url 'password_change' %}" class="btn-secondary change-pass-btn">–°–º–µ–Ω–∏—Ç—å</a>
                </div>
            </div>
        </div>

        <div class="save-bar">
            <button type="submit" class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>

    </form>
</div>

<div id="cropModal" class="crop-modal">
    <div class="crop-container">
        <h3 class="crop-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ</h3>
        <div class="img-container">
            <img id="imageToCrop" src="" alt="Picture">
        </div>
        <div class="crop-actions">
            <button type="button" class="btn-secondary" onclick="closeCropModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="save-btn" id="cropAndSave">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.st-nav-item').forEach(el => el.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫
        const buttons = document.querySelectorAll('.st-nav-item');
        if(tabId === 'profile') buttons[0].classList.add('active');
        if(tabId === 'player') buttons[1].classList.add('active');
        if(tabId === 'interface') buttons[2].classList.add('active');
        if(tabId === 'security') buttons[3].classList.add('active');
    }
</script>

<script>
    let cropper; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫—Ä–æ–ø–ø–µ—Ä–∞
    const avatarInput = document.getElementById('avatarInput');
    const imageToCrop = document.getElementById('imageToCrop');
    const cropModal = document.getElementById('cropModal');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');

    // 1. –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // –í–º–µ—Å—Ç–æ –ø–æ–∫–∞–∑–∞ —Å—Ä–∞–∑—É, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
                openCropModal(e.target.result);
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º value –∏–Ω–ø—É—Ç–∞, —á—Ç–æ–±—ã –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º–µ—Ç "–û—Ç–º–µ–Ω–∞",
                // –æ–Ω –º–æ–≥ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞ (—Å–æ–±—ã—Ç–∏–µ onchange —Å—Ä–∞–±–æ—Ç–∞–ª–æ –±—ã)
                input.value = '';
            }
            reader.readAsDataURL(file);
        }
    }

    // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openCropModal(imageSrc) {
        imageToCrop.src = imageSrc;
        cropModal.style.display = 'flex';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cropper.js
        if (cropper) {
            cropper.destroy();
        }

        cropper = new Cropper(imageToCrop, {
            aspectRatio: 1, // –ö–≤–∞–¥—Ä–∞—Ç (–¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫)
            viewMode: 1,    // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –æ–±–ª–∞—Å—Ç—å –∫—Ä–æ–ø–∞ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
            dragMode: 'move', // –ú–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–∞–ª—å—Ü–µ–º
            autoCropArea: 0.8, // –†–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            restore: false,
            guides: false,
            center: false,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
        });
    }

    // 3. –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.closeCropModal = function() {
        cropModal.style.display = 'none';
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
    }

    // 4. –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
    document.getElementById('cropAndSave').addEventListener('click', function() {
        if (!cropper) return;

        // –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π canvas
        const canvas = cropper.getCroppedCanvas({
            width: 400, // –†–µ—Å–∞–π–∑–∏–º –¥–æ —Ä–∞–∑—É–º–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (—á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å 4–∫ –∞–≤–∞—Ç–∞—Ä–∫–∏)
            height: 400,
        });

        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º canvas –≤ Blob (—Ñ–∞–π–ª)
        canvas.toBlob(function(blob) {
            // 1. –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const url = URL.createObjectURL(blob);
            avatarPreview.src = url;
            avatarPreview.style.display = 'block';
            if (avatarPlaceholder) avatarPlaceholder.style.display = 'none';

            // 2. üî• –ú–ê–ì–ò–Ø: –ü–æ–¥–º–µ–Ω—è–µ–º —Ñ–∞–π–ª –≤ –∏–Ω–ø—É—Ç–µ –Ω–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏–∑ –±–ª–æ–±–∞
            const newFile = new File([blob], "avatar_cropped.png", { type: "image/png" });

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º DataTransfer –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(newFile);
            avatarInput.files = dataTransfer.files;

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            closeCropModal();

            // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç
            // if (typeof showToast === 'function') showToast('–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é', 'success');

        }, 'image/png');
    });
</script>

<script>
    window.changeAccent = function(color) {
        // 1. –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç (—Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º –∞—Ç—Ä–∏–±—É—Ç)
        if (color === 'orange') {
            document.body.setAttribute('data-accent', 'orange');
        } else {
            document.body.removeAttribute('data-accent');
        }

        // 2. üî• –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const input = document.getElementById('accentInput');
        if (input) {
            input.value = color;
        }

        // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫—Ä—É–∂–æ—á–µ–∫
        updateActiveSwatch(color);

        // 4. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û–±–Ω–æ–≤–ª—è–µ–º localStorage –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏,
        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–π–¥–µ—Ç –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        localStorage.setItem('accent', color);
    }

    function updateActiveSwatch(forceColor = null) {
        // –ë–µ—Ä–µ–º —Ü–≤–µ—Ç –ª–∏–±–æ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞, –ª–∏–±–æ –∏–∑ –∏–Ω–ø—É—Ç–∞ (–∏–∑ –±–∞–∑—ã), –ª–∏–±–æ –¥–µ—Ñ–æ–ª—Ç
        const inputVal = document.getElementById('accentInput')?.value;
        const currentColor = forceColor || inputVal || 'purple';

        document.querySelectorAll('.color-swatch').forEach(btn => {
            btn.classList.remove('active');
            if (btn.classList.contains(currentColor)) {
                btn.classList.add('active');
            }
        });
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    updateActiveSwatch();
</script>
{% endblock %}
