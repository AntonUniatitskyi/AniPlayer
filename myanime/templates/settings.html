{% extends 'base.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ | AniParser{% endblock %}

{% block content %}
<div class="settings-container">

    <aside class="settings-sidebar">
        <div class="sidebar-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <nav class="settings-nav">
            <button type="button" class="nav-item active" onclick="switchTab('profile')">
                <span class="icon">üë§</span> –ü—Ä–æ—Ñ–∏–ª—å
            </button>
            <button type="button" class="nav-item" onclick="switchTab('player')">
                <span class="icon">‚ñ∂</span> –ü–ª–µ–µ—Ä
            </button>
            <button type="button" class="nav-item" onclick="switchTab('interface')">
                <span class="icon">üé®</span> –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            </button>
            <button type="button" class="nav-item danger" onclick="switchTab('security')">
                <span class="icon">üõ°</span> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            </button>
        </nav>
    </aside>

    <form method="post" enctype="multipart/form-data" class="settings-content">
        {% csrf_token %}

        <div id="profile" class="tab-pane active">
            <h2 class="pane-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>

            <div class="avatar-upload-section">
                <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(this)">

                <div class="current-avatar" onclick="document.getElementById('avatarInput').click()">
                    {% if user.profile.avatar %}
                        <img id="avatarPreview" src="{{ user.profile.avatar.url }}" alt="Avatar">
                    {% else %}
                        <div id="avatarPlaceholder" class="avatar-placeholder">{{ user.username|first|upper }}</div>
                        <img id="avatarPreview" src="" alt="Avatar" style="display: none;">
                    {% endif %}
                    <div class="edit-overlay">üì∑</div>
                </div>

                <div class="avatar-info">
                    <h3>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                    <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å.</p>
                    <button type="button" class="btn-secondary" onclick="document.getElementById('avatarInput').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ</button>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" name="username" value="{{ user.username }}" class="st-input">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" value="{{ user.email }}" class="st-input">
                </div>
                <div class="form-group full">
                    <label>–û —Å–µ–±–µ</label>
                    <textarea name="bio" class="st-input" rows="3" placeholder="–ü–∞—Ä—É —Å–ª–æ–≤ –æ –≤–∞—à–∏—Ö –≤–∫—É—Å–∞—Ö...">{{ user.profile.bio }}</textarea>
                </div>
            </div>
        </div>

        <div id="player" class="tab-pane">
            <h2 class="pane-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–µ–µ—Ä–∞</h2>
            <div class="settings-list">

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Ä–∏–∏</h3>
                        <p>–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —ç–ø–∏–∑–æ–¥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è.</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="auto_next" {% if user.profile.auto_next %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ–ø–µ–Ω–∏–Ω–≥–∏ (Auto-Skip)</h3>
                        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∂–∏–º–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–ø–µ–Ω–∏–Ω–≥".</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="auto_skip" {% if user.profile.auto_skip_intro %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-item">
                    <div class="st-info">
                        <h3>–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</h3>
                        <p>–í—ã–±–∏—Ä–∞—Ç—å —ç—Ç–æ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.</p>
                    </div>
                    <select name="quality" class="st-select">
                        <option value="1080" {% if user.profile.default_quality == '1080' %}selected{% endif %}>1080p (Full HD)</option>
                        <option value="720" {% if user.profile.default_quality == '720' %}selected{% endif %}>720p (HD)</option>
                        <option value="480" {% if user.profile.default_quality == '480' %}selected{% endif %}>480p (SD)</option>
                    </select>
                </div>

            </div>
        </div>

        <div id="interface" class="tab-pane">
            <h2 class="pane-title">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h2>

            <div class="setting-item">
                <div class="st-info">
                    <h3>–†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ (Backdrop)</h3>
                    <p>–û—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="backdrop_blur" {% if user.profile.backdrop_blur %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-item">
                <div class="st-info">
                    <h3>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</h3>
                    <p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–º–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞.</p>
                </div>
                <label class="switch">
                    <input type="checkbox" name="dark_theme" {% if user.profile.dark_theme %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div id="security" class="tab-pane">
            <h2 class="pane-title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
            {% if user.profile.telegram_id %}
                <div class="tg-connected">
                    <span class="status-badge">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                    <span class="tg-id">ID: {{ user.profile.telegram_id }}</span>
                </div>
                <p style="font-size: 0.85rem; color: var(--text-sec); margin-top: 5px;">
                    –ë–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Å—é–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
                </p>

            {% else %}
                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.</p>
                <a href="{% url 'connect_telegram' %}" class="auth-btn tg-btn" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2z"/></svg>
                    –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram
                </a>
            {% endif %}

            <div class="security-card">
                <div class="sec-info">
                    <h3>–ü–∞—Ä–æ–ª—å</h3>
                    <p>–°–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞ –Ω–æ–≤—ã–π.</p>
                </div>

                <a href="{% url 'password_change' %}" class="btn-secondary change-pass-btn">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</a>
            </div>

            </div>

                <div class="save-bar">
                    <button type="submit" class="btn-primary save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </div>

            </form>
        </div>

<style>
    .tg-btn {
        background: #229ED9; /* –¶–≤–µ—Ç –¢–µ–ª–µ–≥—Ä–∞–º–∞ */
        margin-top: 15px;
        text-decoration: none;
        display: inline-flex;
    }
    .tg-btn:hover { background: #1c85b8; }
    .tg-connected {
        background: rgba(34, 158, 217, 0.1);
        padding: 15px; border-radius: 12px;
        border: 1px solid rgba(34, 158, 217, 0.3);
        display: flex; justify-content: space-between; align-items: center;
    }
    .status-badge { color: #229ED9; font-weight: 700; }
    /* === –°–¢–ò–õ–ò === */
    .settings-container {
        max-width: 1100px; margin: 40px auto;
        display: grid; grid-template-columns: 260px 1fr; gap: 40px;
        padding: 0 20px; align-items: start;
    }

    .settings-sidebar {
        background: var(--surface); border: 1px solid var(--border);
        border-radius: 20px; padding: 20px;
        position: sticky; top: 100px;
    }
    .sidebar-header {
        font-size: 1.2rem; font-weight: 800; color: var(--text-main);
        margin-bottom: 20px; padding-left: 10px;
    }
    .settings-nav { display: flex; flex-direction: column; gap: 5px; }

    .nav-item {
        background: transparent; border: none; text-align: left;
        padding: 12px 15px; border-radius: 12px;
        color: var(--text-sec); font-weight: 600; font-size: 0.95rem;
        cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px;
    }
    .nav-item:hover { background: var(--surface-hover); color: var(--text-main); }
    .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 15px var(--primary-glow); }
    .nav-item.danger { color: #ff6b6b; margin-top: 20px; border: 1px solid rgba(255,107,107,0.1); }
    .nav-item.danger:hover { background: rgba(255,107,107,0.1); }

    .settings-content {
        background: var(--surface); border: 1px solid var(--border);
        border-radius: 24px; padding: 40px; min-height: 500px;
    }
    .tab-pane { display: none; animation: fadeIn 0.3s ease; }
    .tab-pane.active { display: block; }
    .pane-title { margin: 0 0 30px 0; font-size: 1.8rem; font-weight: 800; color: var(--text-main); }

    .avatar-upload-section { display: flex; gap: 25px; align-items: center; margin-bottom: 40px; }
    .current-avatar {
        width: 100px; height: 100px; border-radius: 50%; overflow: hidden;
        position: relative; cursor: pointer; border: 3px solid var(--surface-hover);
    }
    .current-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-placeholder {
        width: 100%; height: 100%; background: var(--input-bg);
        display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; font-weight: 800; color: var(--text-sec);
    }
    .edit-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center;
        opacity: 0; transition: 0.2s; font-size: 1.5rem;
    }
    .current-avatar:hover .edit-overlay { opacity: 1; }
    .avatar-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
    .avatar-info p { margin: 0 0 15px 0; font-size: 0.85rem; color: var(--text-sec); }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group.full { grid-column: 1/-1; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); }
    .st-input, .st-select {
        width: 100%; padding: 12px 16px; background: var(--input-bg);
        border: 1px solid var(--border); border-radius: 10px;
        color: var(--text-main); font-size: 1rem; outline: none; transition: 0.2s;
    }
    .st-input:focus, .st-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }

    .settings-list { display: flex; flex-direction: column; gap: 20px; }
    .setting-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 20px; background: var(--input-bg);
        border: 1px solid var(--border); border-radius: 16px;
    }
    .st-info h3 { margin: 0 0 5px 0; font-size: 1rem; }
    .st-info p { margin: 0; font-size: 0.85rem; color: var(--text-sec); }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute; cursor: pointer; inset: 0;
        background-color: var(--surface-hover); border-radius: 34px; transition: .4s;
        border: 1px solid var(--border);
    }
    .slider:before {
        position: absolute; content: ""; height: 20px; width: 20px;
        left: 3px; bottom: 3px; background-color: white;
        border-radius: 50%; transition: .4s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    input:checked + .slider { background-color: var(--primary); border-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(22px); }

    .btn-secondary {
        background: transparent; border: 1px solid var(--border); color: var(--text-main);
        padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
    }
    .btn-secondary:hover { border-color: var(--text-sec); }

    .save-bar { margin-top: 40px; display: flex; justify-content: flex-end; }
    .save-btn {
        background: var(--primary); color: #fff; border: none;
        padding: 12px 30px; border-radius: 12px; font-weight: 700;
        cursor: pointer; box-shadow: 0 4px 15px var(--primary-glow);
        transition: 0.2s;
    }
    .save-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--primary-glow); }

    @media (max-width: 768px) {
        .settings-container { grid-template-columns: 1fr; gap: 20px; }
        .settings-sidebar { position: static; }
        .settings-nav { flex-direction: row; overflow-x: auto; padding-bottom: 5px; }
        .nav-item { white-space: nowrap; }
        .form-grid { grid-template-columns: 1fr; }
        .setting-item { flex-direction: column; align-items: flex-start; gap: 15px; }
        .switch { align-self: flex-end; }
    }
</style>

<script>
    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ê–ë–û–í
    function switchTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');

        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –¥–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π
        const buttons = document.querySelectorAll('.nav-item');
        if(tabId === 'profile') buttons[0].classList.add('active');
        if(tabId === 'player') buttons[1].classList.add('active');
        if(tabId === 'interface') buttons[2].classList.add('active');
        if(tabId === 'security') buttons[3].classList.add('active');
    }

    // –ü–†–ï–í–¨–Æ –ê–í–ê–¢–ê–†–ö–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('avatarPreview');
                const placeholder = document.getElementById('avatarPlaceholder');

                img.src = e.target.result;
                img.style.display = 'block';
                if(placeholder) placeholder.style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}
