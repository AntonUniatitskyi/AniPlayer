{% extends 'base.html' %}
{% load static %}
{% block title %}–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ {{ user.username }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/library.css' %}">
<div class="library-container">
    <nav class="breadcrumbs">
        <a href="{% url 'home' %}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            –ì–ª–∞–≤–Ω–∞—è
        </a>
        <span class="separator">/</span>
        <span class="current">–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
    </nav>

    <div class="profile-header-wrapper">
        <div class="profile-header">
            <div class="profile-left">
                <div class="avatar-placeholder">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="Avatar">
                    {% else %}
                        {{ user.username|make_list|first|upper }}
                    {% endif %}
                </div>
                <div class="profile-text">
                    <h1>{{ user.username }}</h1>
                    <div class="stats-row">
                        <span class="stat-badge">–¢–∞–π—Ç–ª–æ–≤: {{ library_items.count }}</span>
                        <span class="stat-badge">–° –Ω–∞–º–∏ —Å {{ user.date_joined|date:"Y" }}</span>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <a href="{% url 'settings' %}" class="action-btn settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                    <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </a>
                <form action="{% url 'logout' %}" method="post" style="display:contents;" data-no-swup>
                    {% csrf_token %}
                    <button type="submit" class="action-btn logout">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>

    <div class="library-controls">
        <div class="search-local">
            <span class="search-icon">üîç</span>
            <input type="text" id="librarySearch" placeholder="–§–∏–ª—å—Ç—Ä –∞–Ω–∏–º–µ..." onkeyup="filterLibrary()">
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab(event, 'watching')">
                    –°–º–æ—Ç—Ä—é <span class="count">{{ watching.count }}</span>
                </button>
                <button class="tab-btn" onclick="openTab(event, 'planned')">
                    –í –ø–ª–∞–Ω–∞—Ö <span class="count">{{ planned.count }}</span>
                </button>
                <button class="tab-btn" onclick="openTab(event, 'completed')">
                    –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ <span class="count">{{ completed.count }}</span>
                </button>
                <button class="tab-btn" onclick="openTab(event, 'dropped')">
                    –ë—Ä–æ—à–µ–Ω–æ <span class="count">{{ dropped.count }}</span>
                </button>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div id="watching" class="tab-content active">
            {% include 'includes/anime_grid.html' with anime_list=watching from_library=True empty_msg="–í—ã –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç–µ." %}
        </div>

        <div id="planned" class="tab-content">
            {% include 'includes/anime_grid.html' with anime_list=planned from_library=True empty_msg="–ü–ª–∞–Ω—ã –ø—É—Å—Ç—ã. –°–∞–º–æ–µ –≤—Ä–µ–º—è –ø–æ–ø–æ–ª–Ω–∏—Ç—å!" %}
        </div>

        <div id="completed" class="tab-content">
            {% include 'includes/anime_grid.html' with anime_list=completed from_library=True empty_msg="–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞–Ω–∏–º–µ." %}
        </div>

        <div id="dropped" class="tab-content">
            {% include 'includes/anime_grid.html' with anime_list=dropped from_library=True empty_msg="–°–ø–∏—Å–æ–∫ –±—Ä–æ—à–µ–Ω–Ω—ã—Ö —á–∏—Å—Ç." %}
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        filterLibrary();
    }

    function filterLibrary() {
        const input = document.getElementById('librarySearch');
        const filter = input.value.toLowerCase().trim();
        const activeTab = document.querySelector('.tab-content.active');
        if (!activeTab) return;

        const cards = activeTab.querySelectorAll('.anime-card');

        requestAnimationFrame(() => {
            cards.forEach(card => {
                const title = card.getAttribute('data-name').toLowerCase();
                if (!filter || title.includes(filter)) {
                    card.style.display = "";
                } else {
                    card.style.display = "none";
                }
            });
        });
    }
</script>
{% endblock %}
