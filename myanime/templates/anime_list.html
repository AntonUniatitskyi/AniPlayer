{% extends 'base.html' %}
{% load static %}
{% block title %}Главная | Каталог{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/anime_list.css' %}">
<div class="content-wrapper">

    {# --- SEARCH LOGIC: Hide Slider/History if searching --- #}
    {% if not request.GET.q %}

        {% include 'includes/hero_slider.html' %}

        {% if user.is_authenticated and history %}
        <div class="section-container history-section">
            <div class="section-header">
                <div class="section-title-wrapper">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                    <h2>Продолжить просмотр</h2>
                </div>
            </div>

            <div class="history-shelf">
                {% for item in history %}
                <a href="{% url 'anime_detail' slug=item.episode.anime.code %}" class="history-card">
                    <div class="h-poster">
                        {% if item.episode.anime.poster_path %}
                        <img src="{{ item.episode.anime.poster_path }}" loading="lazy" alt="{{ item.episode.anime.name_ru }}">
                        {% else %}
                        <div class="h-no-poster"></div>
                        {% endif %}
                        <div class="h-overlay">
                            <svg viewBox="0 0 24 24" fill="currentColor" class="play-svg-mini"><path d="M8 5v14l11-7z" /></svg>
                        </div>
                        {% if item.episode %}
                        <div class="h-progress-bar"><div class="bar-fill" style="width: {{ item.progress_percent|default:'0' }}%"></div></div>
                        <div class="h-badge">Серия {{ item.episode.ordinal }}</div>
                        {% endif %}
                    </div>
                    <div class="h-title">{{ item.episode.anime.name_ru }}</div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    {% endif %}


    <div class="page-header">
        {% if request.GET.q %}
            <h1>
                <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                Результаты поиска
            </h1>
            <p>По запросу «{{ request.GET.q }}» найдено:</p>
        {% else %}
            <h1>
                <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                Свежие обновления
            </h1>
            <p>Последние добавленные релизы на сайте</p>
        {% endif %}
    </div>

    <div class="anime-grid">
        {% for anime in anime_list %}
        <a href="{% url 'anime_detail' slug=anime.code %}" class="anime-card">
            <div class="poster-wrapper loading">
                {% if anime.poster_path %}
                <img src="{{ anime.poster_path }}" width="455" height="650" alt="{{ anime.name_ru }}" loading="lazy" decoding="async" onload="this.parentElement.classList.remove('loading')">
                {% else %}
                <div class="no-poster">
                    <svg width="40" height="40" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </div>
                {% endif %}
                <div class="card-overlay">
                    <div class="play-button"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z" /></svg></div>
                </div>
            </div>
            <div class="card-info">
                <h3 class="card-title">{{ anime.name_ru }}</h3>
                <div class="card-meta">
                    {% if anime.updated_at %}
                    <span class="meta-item">{{ anime.updated_at|date:"Y" }}</span>
                    {% endif %}
                    {% if anime.status %}
                    <span class="meta-dot">•</span>
                    <span class="meta-item">{{ anime.status }}</span>
                    {% endif %}
                </div>
            </div>
        </a>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon-box">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <h3>Ничего не найдено</h3>
            <p>Попробуйте изменить запрос.</p>
            {% if request.GET.q %}
                <a href="{% url 'home' %}" class="btn-primary">На главную</a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    {% if is_paginated %}
    <div class="pagination-wrapper">
        <nav class="pagination">
            {% if page_obj.has_previous %}
                <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ page_obj.previous_page_number }}" class="page-btn prev"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></a>
            {% else %}
                <span class="page-btn disabled"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg></span>
            {% endif %}

            <div class="page-numbers">
                {% for i in page_obj.paginator.page_range %}
                    {% if page_obj.number == i %}
                        <span class="page-num active">{{ i }}</span>
                    {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                        <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ i }}" class="page-num">{{ i }}</a>
                    {% endif %}
                {% endfor %}
            </div>

            {% if page_obj.has_next %}
                <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}page={{ page_obj.next_page_number }}" class="page-btn next"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></a>
            {% else %}
                <span class="page-btn disabled"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></span>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const slides = document.querySelectorAll('.hero-slide');
        if(slides.length === 0) return;

        let slideIndex = 0;
        let timer;

        // Dots creation
        let dotsContainer = document.querySelector('.hero-dots');
        if (!dotsContainer) {
            const container = document.querySelector('.hero-container');
            if(container) {
                dotsContainer = document.createElement('div');
                dotsContainer.className = 'hero-dots';
                container.appendChild(dotsContainer);
                slides.forEach((_, i) => {
                    const dot = document.createElement('div');
                    dot.className = i === 0 ? 'dot active' : 'dot';
                    dot.onclick = () => window.currentSlide(i);
                    dotsContainer.appendChild(dot);
                });
            }
        }
        const dots = document.querySelectorAll('.dot');

        function showSlide(n) {
            slideIndex = (n + slides.length) % slides.length;
            slides.forEach(s => s.classList.remove('active'));
            dots.forEach(d => d.classList.remove('active'));

            slides[slideIndex].classList.add('active');
            if(dots[slideIndex]) dots[slideIndex].classList.add('active');
            resetTimer();
        }

        // Make functions global for HTML onclick attributes
        window.currentSlide = function(n) { showSlide(n); }
        window.moveSlide = function(n) { showSlide(slideIndex + n); }

        function nextSlide() { showSlide(slideIndex + 1); }

        function resetTimer() {
            clearInterval(timer);
            timer = setInterval(nextSlide, 5000);
        }

        // Swipe support
        let touchStartX = 0;
        const container = document.querySelector('.hero-container');
        if(container){
            container.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
            container.addEventListener('touchend', e => {
                if (touchStartX - e.changedTouches[0].screenX > 50) nextSlide();
                if (e.changedTouches[0].screenX - touchStartX > 50) showSlide(slideIndex - 1);
            }, {passive: true});
        }

        resetTimer();
    });
</script>
{% endblock %}
