<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {% load static %}
        <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}?v=2">
        <title>{% block title %}AniParser üöÄ{% endblock %}</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ë–ê–ó–ê
           ========================================= */
        :root {
            /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (DEFAULT) */
            --primary: #bb86fc;
            --primary-hover: #9965f4;
            --bg-body: #121212;
            --surface: #1e1e1e;
            --surface-glass: rgba(30, 30, 30, 0.95);
            --text-main: #ffffff;
            --text-sec: #b0b0b0;
            --border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.05);
            --shadow: 0 4px 20px rgba(0,0,0,0.4);

            --glass-bg: rgba(20, 20, 30, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-inner-bg: rgba(255, 255, 255, 0.05);
            --glass-input-bg: rgba(0, 0, 0, 0.3);
        }

        body.light-theme {
            /* –°–í–ï–¢–õ–ê–Ø –¢–ï–ú–ê */
            --primary: #7f39fb;
            --primary-hover: #6200ee;
            --bg-body: #f0f2f5;
            --surface: #ffffff;
            --surface-glass: rgba(255, 255, 255, 0.95);
            --text-main: #1c1c1c;
            --text-sec: #666666;
            --border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 15px rgba(0,0,0,0.1);

            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(0, 0, 0, 0.1);
            --glass-inner-bg: rgba(0, 0, 0, 0.03);
            --glass-input-bg: rgba(255, 255, 255, 0.9);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        main { flex: 1; width: 100%; }

        /* =========================================
           2. –®–ê–ü–ö–ê (HEADER) - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø
           ========================================= */
        header {
            position: sticky; top: 0; z-index: 1000;
            background: var(--surface-glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 10px 0;
            transition: background 0.3s ease;
        }

        .header-container {
            max-width: 1200px; margin: 0 auto; padding: 0 15px;
            display: grid;
            grid-template-columns: auto 1fr auto; /* –õ–æ–≥–æ - –ü–æ–∏—Å–∫ - –ú–µ–Ω—é */
            align-items: center; gap: 20px;
        }

        .logo {
            font-size: 1.3rem; font-weight: 700; color: var(--text-main);
            text-decoration: none; display: flex; align-items: center; gap: 8px;
            white-space: nowrap; flex-shrink: 0;
        }
        .logo span { color: var(--primary); font-size: 1.5rem; }

        /* –ü–û–ò–°–ö */
        .search-wrapper { position: relative; width: 100%; max-width: 450px; justify-self: center; }

        .search-form {
            display: flex; background: var(--input-bg);
            border-radius: 50px; padding: 6px 15px;
            border: 1px solid transparent; width: 100%; transition: all 0.3s ease;
        }
        .search-form:focus-within { background: var(--surface); border-color: var(--primary); box-shadow: 0 0 15px rgba(187, 134, 252, 0.15); }

        .search-input { width: 100%; background: transparent; border: none; color: var(--text-main); outline: none; font-size: 0.95rem; }
        .search-btn { background: none; border: none; color: var(--text-sec); cursor: pointer; padding: 0; display: flex; align-items: center; transition: 0.2s; }
        .search-btn:hover { color: var(--primary); transform: scale(1.1); }

        /* –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –ü–û–ò–°–ö–ê */
        .search-dropdown {
            position: absolute; top: 115%; left: 0; width: 100%;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden; display: none; z-index: 1001;
        }
        .search-dropdown.active { display: block; animation: slideDown 0.2s ease; }

        .search-result-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 15px;
            text-decoration: none; color: var(--text-main);
            border-bottom: 1px solid var(--border); transition: background 0.2s;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--input-bg); }
        .search-result-item img { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .result-info { display: flex; flex-direction: column; overflow: hidden; }
        .result-title { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-hint { font-size: 0.75rem; color: var(--text-sec); }
        .no-results { padding: 15px; text-align: center; color: var(--text-sec); font-size: 0.9rem; }

        /* –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ (–ú–ï–ù–Æ) */
        .nav-actions { display: flex; align-items: center; gap: 10px; }

        .theme-toggle {
            width: 38px; height: 38px; background: transparent; border: 1px solid var(--border);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--text-main); cursor: pointer; transition: 0.2s;
        }
        .theme-toggle:hover { background: var(--input-bg); border-color: var(--text-sec); }

        /* –ò–∫–æ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-btn-icon {
            width: 38px; height: 38px; border-radius: 50%;
            background: var(--primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            text-decoration: none; font-weight: bold; font-size: 0.95rem;
            border: 2px solid var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .profile-btn-icon:hover { transform: scale(1.05); }

        /* –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ (—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–æ–±–∏–ª–∫–µ) */
        .desktop-auth { display: flex; align-items: center; gap: 15px; margin-left: 5px; }
        .auth-link-btn { color: var(--text-main); text-decoration: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; background: none; border: none; padding: 0; font-family: inherit; }
        .auth-link-btn:hover { color: var(--primary); }

        /* –ò–∫–æ–Ω–∫–∏ —Ç–µ–º—ã */
        .icon-sun { display: none; }
        body.light-theme .icon-moon { display: none; }
        body.light-theme .icon-sun { display: block; }


        /* =========================================
           3. –ê–î–ê–ü–¢–ò–í –®–ê–ü–ö–ò –ò –°–õ–ê–ô–î–ï–†–ê
           ========================================= */
        @media (max-width: 768px) {
            /* –•–µ–¥–µ—Ä –≤ 2 —Å—Ç—Ä–æ–∫–∏ */
            .header-container {
                display: flex; flex-wrap: wrap;
                justify-content: space-between; gap: 10px;
            }
            .logo { order: 1; font-size: 1.2rem; }
            .nav-actions { order: 2; margin-left: auto; gap: 8px; }
            .search-wrapper { order: 3; width: 100%; max-width: 100%; margin-top: 5px; }

            /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ */
            .desktop-auth { display: none; }

            /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–ª–∞–π–¥–µ—Ä–∞ (Hero) */
            .hero-container {
                height: 70vh; min-height: 450px;
                border-radius: 0; margin-left: -20px; margin-right: -20px; width: calc(100% + 40px); border: none;
            }
            .hero-slide::after { background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(0,0,0,0.6) 40%, rgba(0,0,0,0) 100%) !important; }
            .hero-bg { background-position: top center; }
            .hero-poster { display: none; }
            .hero-content { flex-direction: column; justify-content: flex-end; align-items: flex-start; height: 100%; padding-bottom: 60px; text-align: left; }
            .hero-title { font-size: 2rem; margin-bottom: 10px; }
            .hero-desc { font-size: 0.95rem; -webkit-line-clamp: 3; margin-bottom: 15px; }
            .hero-actions { width: 100%; }
            .btn-watch { width: 100%; justify-content: center; padding: 14px; }
            .hero-nav { display: none; }
        }


        /* =========================================
           4. –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê (Toasts, Breadcrumbs, Footer)
           ========================================= */

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (TOASTS) */
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast {
            pointer-events: auto; min-width: 250px;
            background: var(--surface); border: 1px solid var(--border);
            border-left: 4px solid var(--primary); color: var(--text-main);
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 12px; font-size: 0.95rem;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), fadeOut 0.5s ease 3.5s forwards;
            cursor: pointer;
        }
        .toast.success { border-left-color: #4caf50; }
        .toast.error { border-left-color: #ff5252; }
        .toast-icon { font-size: 1.2rem; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* –•–õ–ï–ë–ù–´–ï –ö–†–û–®–ö–ò */
        .breadcrumbs {
            display: flex; align-items: center; flex-wrap: wrap; gap: 8px;
            margin-bottom: 25px; font-size: 0.9rem; color: var(--text-sec);
            background: var(--surface-glass); padding: 10px 20px;
            border-radius: 12px; border: 1px solid var(--border);
            backdrop-filter: blur(10px); width: fit-content;
        }
        .breadcrumbs a { color: var(--text-sec); text-decoration: none; transition: color 0.2s ease; display: flex; align-items: center; gap: 6px; }
        .breadcrumbs a:hover { color: var(--primary); }
        .breadcrumbs .separator { color: var(--border); font-size: 0.8rem; }
        .breadcrumbs .current { color: var(--text-main); font-weight: 500; pointer-events: none; }

        @media (max-width: 600px) {
            .breadcrumbs { font-size: 0.8rem; padding: 8px 15px; width: 100%; }
        }

        /* –§–£–¢–ï–† */
        footer {
            background: var(--surface); border-top: 1px solid var(--border);
            padding: 30px 0; margin-top: auto; text-align: center;
            color: var(--text-sec); font-size: 0.9rem;
        }

    </style>
</head>
<body>

    <header>
        <div class="header-container">
            <a href="{% url 'home' %}" class="logo"><span>‚ñ∂</span> AniPlayer</a>

            <div class="search-wrapper">
                <form action="{% url 'home' %}" method="get" class="search-form" autocomplete="off">
                    <input id="searchInput" type="text" name="q" class="search-input" placeholder="–ù–∞–π—Ç–∏ –∞–Ω–∏–º–µ..." value="{{ request.GET.q }}">
                    <button type="submit" class="search-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </form>
                <div id="searchResults" class="search-dropdown"></div>
            </div>

            <div class="nav-actions">

                <button class="theme-toggle" id="themeBtn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
                    <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>

                {% if user.is_authenticated %}
                    <a href="{% url 'library' %}" class="profile-btn-icon" title="–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç">
                        {{ user.username|make_list|first|upper }}
                    </a>
                    <div class="desktop-auth">
                         <form action="{% url 'logout' %}" method="post" style="display:inline;">
                             {% csrf_token %}
                             <button type="submit" class="auth-link-btn" style="color: #ff6b6b;">–í—ã–π—Ç–∏</button>
                         </form>
                    </div>
                {% else %}
                    <div class="desktop-auth">
                        <a href="{% url 'login' %}" class="auth-link-btn">–í–æ–π—Ç–∏</a>
                        <a href="{% url 'register' %}" class="auth-link-btn" style="color: var(--primary);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                    <a href="{% url 'login' %}" class="profile-btn-icon" style="background: var(--surface); border-color: var(--border); color: var(--text-main);" title="–í–æ–π—Ç–∏">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                    </a>
                {% endif %}
            </div>
        </div>
    </header>

    <main>{% block content %}{% endblock %}</main>

    <footer><div class="header-container"><p>&copy; 2025 AniParser Project. Created with Django & Python.</p></div></footer>

    <script>
        // === –õ–û–ì–ò–ö–ê –¢–ï–ú–´ ===
        const themeBtn = document.getElementById('themeBtn');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') body.classList.add('light-theme');
        themeBtn.addEventListener('click', () => {
            body.classList.toggle('light-theme');
            localStorage.setItem('theme', body.classList.contains('light-theme') ? 'light' : 'dark');
        });

        // === –ñ–ò–í–û–ô –ü–û–ò–°–ö ===
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let debounceTimer;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä (Debounce - —á—Ç–æ–±—ã –Ω–µ –¥–æ–ª–±–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –Ω–∞ –∫–∞–∂–¥—É—é –±—É–∫–≤—É)
            clearTimeout(debounceTimer);

            if (query.length < 2) {
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
                return;
            }

            // –ñ–¥–µ–º 300–º—Å –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–≤–æ–¥–∞, –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å
            debounceTimer = setTimeout(() => {
                fetch(`/api/search/?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        searchResults.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä–æ–µ

                        if (data.results.length > 0) {
                            data.results.forEach(anime => {
                                // –°–æ–∑–¥–∞–µ–º HTML –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                                const html = `
                                    <a href="/anime/${anime.slug}/" class="search-result-item">
                                        <img src="${anime.poster || ''}" alt="${anime.name}">
                                        <div class="result-info">
                                            <span class="result-title">${anime.name}</span>
                                            <span class="result-hint">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É</span>
                                        </div>
                                    </a>
                                `;
                                searchResults.insertAdjacentHTML('beforeend', html);
                            });
                            searchResults.classList.add('active');
                        } else {
                            searchResults.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî</div>';
                            searchResults.classList.add('active');
                        }
                    })
                    .catch(err => console.error('Search Error:', err));
            }, 300);
        });

        // –°–∫—Ä—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–∏—Å–∫–∞
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–Ω–æ–≤–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ, –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
        searchInput.addEventListener('focus', function() {
            if (this.value.length >= 2 && searchResults.children.length > 0) {
                searchResults.classList.add('active');
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showToast(message, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';

            toast.innerHTML = `<span class="toast-icon">${icon}</span> <span>${message}</span>`;

            // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
            toast.onclick = () => toast.remove();

            container.appendChild(toast);

            // –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏)
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ "–°–º–æ—Ç—Ä—é"', 'success');
    </script>
    <div id="toast-container"></div>
</body>
</html>
